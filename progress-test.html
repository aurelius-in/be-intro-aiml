<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress Test - BEST</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDPBH5ifyna8jYilqjneh9sRlWg6Z1kS0Y",
            authDomain: "best-6bc96.firebaseapp.com",
            projectId: "best-6bc96",
            storageBucket: "best-6bc96.appspot.com",
            messagingSenderId: "835354586616",
            appId: "1:835354586616:web:931af2d81b25c287dcba0d",
            measurementId: "G-7TQN3QPPTX"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);

        // Function to save progress
        async function saveProgress(userId, progress) {
            try {
                await setDoc(doc(db, "progress", userId), { progress });
                console.log("Progress saved!");
            } catch (error) {
                console.error("Error saving progress: ", error);
            }
        }

        // Function to load progress
        async function loadProgress(userId) {
            try {
                const docRef = doc(db, "progress", userId);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data().progress;
                } else {
                    console.log("No progress found!");
                    return {};
                }
            } catch (error) {
                console.error("Error loading progress: ", error);
                return {};
            }
        }

        // Function to handle checkbox changes
        function handleCheckboxChange(userId, checkboxes) {
            const progress = {};
            checkboxes.forEach((checkbox, index) => {
                progress[`class${index + 1}`] = checkbox.checked;
            });
            saveProgress(userId, progress);
            updateFinalExamButton(checkboxes);
        }

        // Function to update the final exam button state
        function updateFinalExamButton(checkboxes) {
            const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
            document.getElementById("finalExamButton").disabled = !allChecked;
        }

        // Initialize the page
        document.addEventListener("DOMContentLoaded", () => {
            const checkboxes = document.querySelectorAll("input[type=checkbox]");
            const finalExamButton = document.getElementById("finalExamButton");
            const loginStatus = document.getElementById("loginStatus");

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    loginStatus.textContent = `Logged in as ${user.email}`;
                    console.log("User logged in: ", user);
                    const progress = await loadProgress(user.uid);
                    checkboxes.forEach((checkbox, index) => {
                        checkbox.checked = progress[`class${index + 1}`] || false;
                    });
                    updateFinalExamButton(checkboxes);
                    checkboxes.forEach(checkbox => {
                        checkbox.addEventListener("change", () => handleCheckboxChange(user.uid, checkboxes));
                    });
                } else {
                    loginStatus.textContent = "Not logged in";
                    console.log("No user logged in");
                }
            });

            finalExamButton.disabled = true;
        });
    </script>
</head>
<body>
    <header>
        <a href="index.html"><img src="logo-1x1.svg" alt="BEST Logo" class="logo"></a>
    </header>
    <main>
        <h1>Progress Tracking</h1>
        <p id="loginStatus">Checking login status...</p>
        <div>
            <label><input type="checkbox" id="class1"> Class 1 Complete</label><br>
            <label><input type="checkbox" id="class2"> Class 2 Complete</label><br>
            <label><input type="checkbox" id="class3"> Class 3 Complete</label><br>
            <label><input type="checkbox" id="class4"> Class 4 Complete</label><br>
            <label><input type="checkbox" id="class5"> Class 5 Complete</label><br>
            <label><input type="checkbox" id="class6"> Class 6 Complete</label><br>
            <label><input type="checkbox" id="class7"> Class 7 Complete</label><br>
        </div>
        <button id="finalExamButton" disabled>Take Final Exam</button>
    </main>
    <footer>
        <p>&copy; 2024 Blue Eagle School of Technology. All rights reserved.</p>
    </footer>
</body>
</html>
