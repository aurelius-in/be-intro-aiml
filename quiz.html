<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPBH5ifyna8jYilqjneh9sRlWg6Z1kS0Y",
            authDomain: "best-6bc96.firebaseapp.com",
            projectId: "best-6bc96",
            storageBucket: "best-6bc96.appspot.com",
            messagingSenderId: "835354586616",
            appId: "1:835354586616:web:931af2d81b25c287dcba0d",
            measurementId: "G-7TQN3QPPTX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);

        async function loadQuizData(course, module) {
            try {
                const response = await fetch(`${course}/${module}-quiz.json`);
                const quizData = await response.json();
                displayQuiz(quizData);
            } catch (error) {
                document.getElementById("quiz-content").innerText = `Error loading quiz: ${error.message}`;
            }
        }

        function displayQuiz(quizData) {
            const quizContent = document.getElementById("quiz-content");
            quizContent.innerHTML = `<h2>${quizData.title}</h2>`;
            quizData.questions.forEach((question, index) => {
                const questionElement = document.createElement("div");
                questionElement.className = "question";
                questionElement.innerHTML = `
                    <p>${index + 1}. ${question.title}</p>
                    ${question.options.map((option, i) => `
                        <label>
                            <input type="radio" name="question${index}" value="${String.fromCharCode(97 + i)}">
                            ${option}
                        </label>
                    `).join("")}
                `;
                quizContent.appendChild(questionElement);
            });
            const submitButton = document.createElement("button");
            submitButton.innerText = "Submit";
            submitButton.addEventListener("click", () => gradeQuiz(quizData));
            quizContent.appendChild(submitButton);
        }

        async function gradeQuiz(quizData) {
            const quizContent = document.getElementById("quiz-content");
            let score = 0;
            const answers = {};

            quizData.questions.forEach((question, index) => {
                const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                if (selectedOption) {
                    answers[`question${index}`] = selectedOption.value;
                    if (selectedOption.value === question.correct) {
                        score++;
                    }
                } else {
                    answers[`question${index}`] = null;
                }
            });

            const user = auth.currentUser;
            if (user) {
                const quizResult = {
                    score,
                    total: quizData.questions.length,
                    answers,
                    status: score >= quizData.questions.length * 0.7 ? 'passed' : 'failed'
                };
                const quizRef = doc(db, "progress", `${user.uid}-${quizData.title}`);
                await setDoc(quizRef, quizResult);
            }

            quizContent.innerHTML = `<p>You scored ${score} out of ${quizData.questions.length}</p>`;
            quizData.questions.forEach((question, index) => {
                const selectedOption = document.querySelector(`input[name="question${index}"]:checked`);
                const resultElement = document.createElement("p");
                resultElement.innerHTML = `
                    Question ${index + 1}: ${question.title} <br>
                    Your answer: ${selectedOption ? selectedOption.value : 'None'} <br>
                    Correct answer: ${question.correct} <br>
                    Explanation: ${question.explanation}
                `;
                quizContent.appendChild(resultElement);
            });
        }

        function handleAuth() {
            const user = auth.currentUser;
            if (user) {
                const urlParams = new URLSearchParams(window.location.search);
                const course = urlParams.get('course');
                const module = urlParams.get('module');
                loadQuizData(course, module);
            } else {
                document.getElementById("quiz-content").innerHTML = `
                    <p>To ensure your progress is saved, please sign in again.</p>
                    <form id="login-form">
                        <input type="email" id="email" placeholder="Email" required>
                        <input type="password" id="password" placeholder="Password" required>
                        <button type="submit">Sign In</button>
                    </form>
                `;
                document.getElementById("login-form").addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const email = document.getElementById("email").value;
                    const password = document.getElementById("password").value;
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        document.getElementById("quiz-content").innerHTML = "";
                        handleAuth();
                    } catch (error) {
                        document.getElementById("quiz-content").innerHTML = `<p>Error: ${error.message}</p>`;
                    }
                });
            }
        }

        onAuthStateChanged(auth, handleAuth);
    </script>
</head>
<body>
    <header>
        <a href="index.html"><img src="logo-1x1.svg" alt="BEST Logo" class="logo"></a>
    </header>
    <main>
        <h1>Quiz</h1>
        <div id="quiz-content"></div>
    </main>
    <footer>
        <p>&copy; 2024 Blue Eagle School of Technology. All rights reserved.</p>
    </footer>
</body>
</html>
