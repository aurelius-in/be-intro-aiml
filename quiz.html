<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz</title>
    <link rel="stylesheet" href="styles.css">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDPBH5ifyna8jYilqjneh9sRlWg6Z1kS0Y",
            authDomain: "best-6bc96.firebaseapp.com",
            projectId: "best-6bc96",
            storageBucket: "best-6bc96.appspot.com",
            messagingSenderId: "835354586616",
            appId: "1:835354586616:web:931af2d81b25c287dcba0d",
            measurementId: "G-7TQN3QPPTX"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);

        async function saveQuizProgress(quizId, answers) {
            const user = auth.currentUser;
            if (user) {
                const docRef = doc(db, "quizProgress", user.uid);
                try {
                    await setDoc(docRef, { [quizId]: answers }, { merge: true });
                    console.log("Quiz progress saved successfully!");
                } catch (error) {
                    console.error("Error saving quiz progress: ", error);
                }
            }
        }

        async function loadQuiz() {
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const program = urlParams.get('program');
            const module = urlParams.get('module');

            if (program && module) {
                try {
                    const response = await fetch(`quizzes/${program}/${module}-quiz.json`);
                    const quizData = await response.json();
                    document.getElementById('quizTitle').textContent = quizData.title;

                    const form = document.getElementById('quizForm');
                    quizData.questions.forEach((question, index) => {
                        const questionContainer = document.createElement('div');
                        questionContainer.innerHTML = `
                            <h2>${question.title}</h2>
                            ${question.options.map((option, i) => `
                                <input type="radio" id="q${index+1}${String.fromCharCode(97+i)}" name="q${index+1}" value="${String.fromCharCode(97+i)}">
                                <label for="q${index+1}${String.fromCharCode(97+i)}">${option}</label><br>
                            `).join('')}
                            <p id="q${index+1}Explanation"></p>
                        `;
                        form.appendChild(questionContainer);
                    });
                } catch (error) {
                    console.error("Error loading quiz: ", error);
                }
            } else {
                console.error("No program or module parameter provided in the URL");
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadQuiz();

            document.getElementById('quizForm').addEventListener('submit', function(event) {
                event.preventDefault();

                const queryString = window.location.search;
                const urlParams = new URLSearchParams(queryString);
                const program = urlParams.get('program');
                const module = urlParams.get('module');
                const quizId = `${program}-${module}`;

                const formData = new FormData(event.target);
                const answers = {};
                formData.forEach((value, key) => {
                    answers[key] = value;
                });

                fetch(`quizzes/${program}/${module}-quiz.json`)
                    .then(response => response.json())
                    .then(quizData => {
                        let score = 0;
                        quizData.questions.forEach((question, index) => {
                            const answer = answers[`q${index+1}`];
                            const correctAnswer = question.correct;
                            if (answer === correctAnswer) {
                                score++;
                                document.getElementById(`q${index+1}Explanation`).textContent = 'Correct!';
                            } else {
                                document.getElementById(`q${index+1}Explanation`).textContent = `Incorrect. The correct answer is ${correctAnswer}. ${question.explanation}`;
                            }
                        });
                        alert(`You scored ${score} out of ${quizData.questions.length}`);

                        saveQuizProgress(quizId, answers);
                    });
            });
        });
    </script>
</head>
<body>
    <header>
        <a href="index.html"><img src="logo-1x1.svg" alt="BEST Logo" class="logo"></a>
    </header>
    <main>
        <h1 id="quizTitle">Loading...</h1>
        <form id="quizForm"></form>
    </main>
    <footer>
        <p>&copy; 2024 Blue Eagle School of Technology. All rights reserved.</p>
    </footer>
</body>
</html>
